---
title: "Heatwave Analysis"
output: html_document
date: "2025-07-15"
---

```{r set.knitr.options, include= FALSE, message=FALSE, warning=FALSE}
#-----set knitr options-----

# clear environment
rm(list = ls())

# knitr options
suppressMessages(library(knitr))
opts_chunk$set(tidy = FALSE, echo = TRUE, message = FALSE)

# Load pacman, installing if needed and other packages as needed
if (!require("pacman")) { install.packages("pacman", repos = "http://cran.r-project.org") }

# Load other packages, installing as needed.
pacman::p_load(tidyverse, scales)


# Set working directory 
setwd("~/PINC 2025/Bilaoen-PSP-2025/Climate Change Data")


```

# Heatwaves

According to the CDC (Centers for Disease Control and Prevention), a heatwave is a period of abnormally and uncomfortably hot and unusually humid weather, typically lasting two or more days. The definition can vary by location, but heatwaves are generally characterized by temperatures that are significantly higher than the average for a given area and time of year, and they can pose serious health risks, especially to older adults, children, and people with chronic conditions. For more information see: <https://www.cdc.gov/climate-health/php/resources/protect-yourself-from-the-dangers-of-extreme-heat.html>

Climate Change and Extreme Heat Events: <https://www.cdc.gov/climate-health/media/pdfs/ClimateChangeandExtremeHeatEvents.pdf>

Heatwave based on temperature and vapor pressure.

NCEI (National Centers for Environmental Information) calculates the 85th-percentile threshold for each MSA, both for minimum daily temperatures and for maximum daily temperatures. Using these data, EPA compared each city’s daily minimum apparent temperature records with that city’s corresponding 85th-percentile threshold. EPA identified a heat wave whenever two or more consecutive days exceeded the threshold, then quantified the following four metrics for each city and each year:

• Frequency: the number of distinct heat waves that occur every year.

• Duration: the length of each individual heat wave, in days. These data can be aggregated to find the average duration of individual heat waves over a time period such as a year or a decade.

• Season length: the number of days from the first day of the first heat wave of the year to the last day of the last heat wave, including the first and last days in the count.

• Intensity: how hot the temperature is during a heat wave, compared with the corresponding city-specific threshold. For example, if a city has an 85th-percentile threshold of 95°F, and the average of the daily minimum apparent temperatures during a three-day heat wave was 98°F, the intensity would be recorded as 3°F above the threshold.

Hence, health warnings about extreme heat are often based on NWS’s Heat Index, which is similar to apparent temperature in that it combines temperature and humidity (albeit with a different formula). This indicator specifically uses daily minimum temperature because studies show that mortality is more closely related to elevated daily minimum temperature than to daily maximum or daily mean temperature (Habeeb et al., 2015; Sarofim et al., 2016), as warm nighttime temperatures prevent the body from cooling off after a hot day. For each MSA, NCEI calculated daily maximum and minimum apparent temperature for each day based on hourly temperature and humidity measurements.

NCEI derived apparent temperature using the following equation:

AT = -1.3 + 0.92T + 2.2e

where AT is the apparent temperature (°C), T is ambient air temperature (°C), and e is water vapor pressure (kilopascals). This equation was established by Steadman (1984).

Based on Huang et al. (2021) we will examine the 97.5th percentile of apparent temperature, based on the minimum temperature. We will use the NCEI equation for apparent temperature, which does differ from Huang et al.'s (2021) equation that uses dew point instead.

Definitions:

1.  AT \> 85th percentile for 2+ days

2.  AT \> 85th percentile for 3+ days

3.  AT \> 97.5th percentile for 2+ days

4.  AT \> 97.5th percentile for 3+ days

```{r load.data, echo= FALSE}

# Step 0: Load downloaded and pre-processed clean daymet data

sf_daymet <- read_csv("sf_daymet_clean.csv")

```

Water vapor pressure vp Pa Water vapor pressure in pascals. Daily average partial pressure of water vapor.

We need to transform the vp variable from pascals to kilopascals. We divide the pressure value by 1000.

```{r apparent.temperature, echo = FALSE}
#  unique(sf_daymet$measurement)
# [1] "dayl" "prcp" "srad" "swe"  "tmax" "tmin" "vp" 

#Calculate tmean
# temp_data <- sf_daymet %>%
#   filter(measurement %in% c("tmax", "tmin")) %>%
#   pivot_wider(names_from = measurement, values_from = value) %>%
#   mutate(tmean = (tmax + tmin) / 2)


# Step 1: pivot data to wide format 
temp_data <- sf_daymet %>%
  filter(measurement %in% c("tmax", "tmin", "vp")) %>%
  pivot_wider(names_from = measurement, values_from = value) 

# kilopascals 
temp_data <- temp_data %>% 
              mutate(vp_kp = vp/1000)

# add AT 

# AT = -1.3 + 0.92T + 2.2e

temp_data <- temp_data %>% 
              mutate(AT = (-1.3 + 0.92 * (tmin) + 2.2 * (vp_kp)) )

# Reshape to long format
long_temp <- temp_data %>%
  select(site, year, yday, tmax, tmin, vp, vp_kp, AT) %>%
  pivot_longer(cols = c(tmax, tmin, vp, vp_kp, AT),
               names_to = "measurement",
               values_to = "value")

# Calculate 97.5th percentile per site & measurement

# tenyear_percentiles <- long_temp %>%
#   filter(year >= 2000 & year <= 2010) %>%     # Optional: first 10 years of data 
#   group_by(site, measurement) %>%
#   mutate(p97_5 = quantile(value, probs = 0.975, na.rm = TRUE), # percentiles are VERY similar when looking at 2000s
#             p85 = quantile(value, probs = 0.85, na.rm = TRUE))
# 


percentiles <- long_temp %>%
  filter(year >= 2000 & year <= 2020) %>%     # using 2000-2020 data in analysis 
  group_by(site, measurement) %>%
  mutate(p97_5 = quantile(value, probs = 0.975, na.rm = TRUE),
            p85 = quantile(value, probs = 0.85, na.rm = TRUE))


# filtering to only keep the AT data 
percentiles <- percentiles %>% filter(measurement == "AT")


```


How many "hot days" do we have per year per site (by year)?

```{r hot.days, echo= FALSE}

# Add threshold and flag hot days
long_temp_flagged <- percentiles %>%
  mutate(hot_day_85 = value >= p85,
         hot_day_97_5 = value >= p97_5)

# count how many days are flagged as hot days 
hot_days_summary <- long_temp_flagged %>%
  group_by(site, year) %>%
  summarise(
    n_hot_day_85 = sum(hot_day_85, na.rm = TRUE),
    n_hot_day_97_5 = sum(hot_day_97_5, na.rm = TRUE),
    .groups = "drop"
  )

# View first six rows of summary
head(hot_days_summary)


# visualizing


# ggplot(hot_days_summary, aes(x = year)) +
#   geom_line(aes(y = n_hot_day_85, color = "85th percentile")) +
#   geom_line(aes(y = n_hot_day_97_5, color = "97.5th percentile")) +
#   facet_wrap(~ site, scales = "free_y") +
#   labs(
#     title = "Number of Hot Days per Year by Site",
#     x = "Year", y = "Number of Hot Days",
#     color = "Threshold"
#   ) +
#   theme_minimal() + 
#  theme(plot.title = element_text(hjust = 0.5))




# Reshape for plotting
# hot_days_summary_long <- hot_days_summary %>%
#   pivot_longer(cols = starts_with("n_hot_day"),
#                names_to = "threshold", values_to = "count")
# 
# ggplot(hot_days_summary_long, aes(x = factor(year), y = count, fill = threshold)) +
#   geom_col(position = "dodge") +
#   facet_wrap(~ site, scales = "free_y") +
#   labs(
#     title = "Number of Hot Days per Year by Threshold",
#     x = "Year", y = "Count",
#     fill = "Threshold"
#   ) +
#   theme_minimal()  + 
#  theme(plot.title = element_text(hjust = 0.5))



# averages across city = avg number of hot days per yr 
hot_days_avg <- hot_days_summary %>%
  group_by(year) %>%
  summarise(
    mean_hot_day_85 = mean(n_hot_day_85, na.rm = TRUE),
    mean_hot_day_97_5 = mean(n_hot_day_97_5, na.rm = TRUE),
    .groups = "drop"
  ) 


ggplot(hot_days_avg, aes(x = year)) +
  geom_line(aes(y = mean_hot_day_85, color = "85th percentile")) +
  geom_line(aes(y = mean_hot_day_97_5, color = "97.5th percentile")) +
  labs(
    title = "Average Number of Hot Days per Year Across All SF",
    x = "Year", y = "Average Hot Days",
    color = "Threshold"
  ) +
  theme_minimal()  + 
 theme(plot.title = element_text(hjust = 0.5))


```





Now lets calculate the heat waves! We will use the four definitions we described above. 

```{r heatwave.calculation, echo = FALSE}


long_temp_flagged_new <- long_temp_flagged %>%
  group_by(site, measurement, year) %>%
  arrange(yday, .by_group = TRUE) %>%
  mutate(
    # Streaks of 2+ for hot_day_85
    streak_85_2 = {
      r <- rle(hot_day_85)
      inverse.rle(list(
        lengths = r$lengths,
        values = r$values & r$lengths >= 2
      ))
    },
    # Streaks of 3+ for hot_day_85
    streak_85_3 = {
      r <- rle(hot_day_85)
      inverse.rle(list(
        lengths = r$lengths,
        values = r$values & r$lengths >= 3
      ))
    },
    # Streaks of 2+ for hot_day_97_5
    streak_97_5_2 = {
      r <- rle(hot_day_97_5)
      inverse.rle(list(
        lengths = r$lengths,
        values = r$values & r$lengths >= 2
      ))
    },
    # Streaks of 3+ for hot_day_97_5
    streak_97_5_3 = {
      r <- rle(hot_day_97_5)
      inverse.rle(list(
        lengths = r$lengths,
        values = r$values & r$lengths >= 3
      ))
    }
  ) %>%
  ungroup()

# Preview the result
head(long_temp_flagged_new)

```



```{r heatwave.counting, echo = FALSE}

# Helper function to count qualifying streaks
count_streaks <- function(x, min_length) {
  r <- rle(x)
  sum(r$values & r$lengths >= min_length)
}

# Main heat wave summary
heat_wave_summary <- long_temp_flagged %>%
  filter(measurement == "AT") %>%
  group_by(site, year) %>%
  arrange(yday, .by_group = TRUE) %>%  # ensure correct order
  summarise(
    hw_2day_85   = count_streaks(hot_day_85, 2),
    hw_3day_85   = count_streaks(hot_day_85, 3),
    hw_2day_97_5 = count_streaks(hot_day_97_5, 2),
    hw_3day_97_5 = count_streaks(hot_day_97_5, 3),
    .groups = "drop"
  )

# save a copy of the heat wave data 

# write.csv(heat_wave_summary, "heat_wave_summary.csv", row.names = FALSE)

  
```

# Answering Research Question 1: What are the temporal patterns of extreme heat events in San Francisco from 2000–2020?

Each team member can work on one of the heat wave definitions to answer the question above. 



## Heatwaves: 2+ days at 85th percentile 


```{r}
summary_hw_2day_85 <-   heat_wave_summary %>% 
    group_by(year) %>% 
    summarise(avg_hw_2day_85 = mean(hw_2day_85, na.rm = TRUE),
              .groups = "drop")
  
  summary_hw_2day_85 %>%  ggplot(aes (x = year, y = avg_hw_2day_85)) + geom_col(stat = "identity") + geom_smooth(method = "loess")
  
  
```

## Heatwaves: 3+ days at 85th percentile 


```{r}

  summary_hw_3day_85 <-   heat_wave_summary %>% 
    group_by(year) %>% 
    summarise(avg_hw_3day_85 = mean(hw_3day_85, na.rm = TRUE),
              .groups = "drop")
  
  summary_hw_3day_85 %>%  ggplot(aes (x = year, y = avg_hw_3day_85)) + geom_col(stat = "identity") + geom_smooth(method = "loess")
  
```



## Heatwaves: 2+ days at 97.5th percentile 


```{r}
    summary_hw_2day_97_5 <-   heat_wave_summary %>% 
    group_by(year) %>% 
    summarise(avg_hw_2day_97_5 = mean(hw_2day_97_5, na.rm = TRUE),
              .groups = "drop")
  
  summary_hw_2day_97_5 %>%  ggplot(aes (x = year, y = avg_hw_2day_97_5)) + geom_col(stat = "identity") + geom_smooth(method = "loess")
  
#linear model 
  model_lm_hw_2day_97_5 <- lm(avg_hw_2day_97_5 ~ year, data = summary_hw_2day_97_5)

summary(model_lm_hw_2day_97_5)
  
```


## Heatwaves: 3+ days at 97.5th percentile 

```{r}

  summary_hw_3day_97_5 <-   heat_wave_summary %>% 
    group_by(year) %>% 
    summarise(avg_hw_3day_97_5 = mean(hw_3day_97_5, na.rm = TRUE),
              .groups = "drop")
  
  summary_hw_3day_97_5 %>%  ggplot(aes (x = year, y = avg_hw_3day_97_5)) + geom_col(stat = "identity") + geom_smooth(method = "loess")
  
```


